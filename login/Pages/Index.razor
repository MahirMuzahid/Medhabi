@page "/"
@using login.Data
@inject ServerConnection connect
@inject NavigationManager NavigationManager
@inject Blazored.LocalStorage.ILocalStorageService oLocalStore 

<div class="limiter">
    <div class="container-login100">
        <div class="wrap-login100">
            <div class="login100-pic js-tilt" data-tilt>
                <img src="images/img-01.png" alt="IMG">
            </div>

            <form class="login100-form validate-form">
                <span class="login100-form-title">
                    Student Sign In
                </span>
                <p style="color:red">@Error</p>
                <div class="wrap-input100 " data-validate="Valid email is required: ex@abc.xyz">
                    <input class="input100" @bind="mail" type="text" name="email" placeholder="Email">
                    <span class="focus-input100"></span>
                    <span class="symbol-input100">
                        <i class="fa fa-envelope" aria-hidden="true"></i>
                    </span>
                </div>

                <div class="wrap-input100 " data-validate="Password is required">
                    <input class="input100" @bind="pass" type="password" name="pass" placeholder="Password">
                    <span class="focus-input100"></span>
                    <span class="symbol-input100">
                        <i class="fa fa-lock" aria-hidden="true"></i>
                    </span>
                </div>

                <div class="container-login100-form-btn">
                    <button class="login100-form-btn" type="button" @onclick="login">
                        @Logintxt
                    </button>
                </div>

                <div class="text-center p-t-12">
                    <span class="txt1">
                        Forgot
                    </span>
                    <a class="txt2" href="#">
                        Username / Password?
                    </a>
                </div>

                <div class="text-center p-t-136">
                    <a class="txt2" href="/signup">
                        Create your Account
                        <i class="fa fa-long-arrow-right m-l-5" aria-hidden="true"></i>
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>
@code{
    private string mail, pass, Error, Logintxt;

    string sessionMsg = "";
    string sessionValue = "";


    protected override async Task OnInitializedAsync()
    {
        Student student = new Student();
        student.mail = await oLocalStore.GetItemAsync<string>("mail");
        student.password = await oLocalStore.GetItemAsync<string>("password");
        if(student.mail != null && student.password != null)
        {
            NavigationManager.NavigateTo("/dashboard");
        }
        else
        {
            Logintxt = "Login";
        }

    }

    public async Task SaveSession(string mail, string password)
    {
        await oLocalStore.SetItemAsync("mail", mail);
        await oLocalStore.SetItemAsync("password", password);
    }


    private async Task login()
    {
        Logintxt = "Wait...";
        if (mail != null && pass != null )
        {
            await Task.Run(() => connect.SignIn(mail, pass));
            nevigate();
        }
        else
        {
            Error = "Can't use empty box";
        }
    }

    public async void nevigate()
    {
        Student student = connect.student;
        if (connect.submitted == 0)
        {

            await Task.Run(() => SaveSession(student.mail, student.password));

            NavigationManager.NavigateTo("/dashboard");
        }
        else
        {
            Error = "Wrong Username or Password";
        }
    }


}